{% extends 'supernova/two_columns.html' %}
{% load static %}
{% load misc %}

{% block head %}
  <script src="{% static 'js/lib/particles.min.js' %}"></script>
  <script async>particlesJS.load('particles', "{% static 'particles.json' %}");</script>
  <script src="{% static 'js/lib/d3.min.js' %}"></script>
{% endblock %}

{% block content_wrapper %}
  <div id="particles"></div>
  <div class="row padded nowrap">
    <div class="col">
      {% if message %}
        <div class="flex-pane" style="flex-basis: 0">
          <div class="pane-title bg-grad"><h2>Informação</h2></div>
          <div class="pane-content">
            {{ message|safe }}
          </div>
        </div>
      {% endif %}
      <div class="flex-pane">
        <div class="pane-title bg-grad">
          <h2><a href="{% url 'news:index' %}">Notícias</a></h2>
        </div>
        <div class="pane-content news">
          {% for news_item in news %}
            <div class="news-list-item">
              {% if news_item.cover_img %}
                <img src="{{ news_item.cover_thumbnail.url }}" alt="{{ news_item.title }}">
              {% endif %}
              <div>
                <h3><a href="{% url 'news:item' news_item.id %}">{{ news_item.title }}</a></h3>
                {% if news_item.author %}
                  <span>Por <a href="{% url 'users:schedule' news_item.author.nickname %}"> {{ news_item.author.nickname }}</a>,
                    {{ news_item.datetime }}</span>
                {% else %}
                  <span><a href="{{ news_item.source }}">Fonte</a>, {{ news_item.datetime.date }}</span>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
      <div class="row grow">
        <div class="col grow noshrink" style="flex-basis: 500px;">
          <div class="flex-pane grow">
            <div class="pane-title bg-grad"><h2>Atividade</h2></div>
            <div class="pane-content">
              {% for activity in activities %}
                {% if not forloop.first %}
                  <hr>{% endif %}
                <div>
                  {% with activity.link_to as link %}
                    {% if link %}
                      <a href="{{ link }}"><h4>{{ activity.title }}</h4></a>
                    {% else %}
                      <h4>{{ activity.title }}</h4>
                    {% endif %}
                  {% endwith %}
                </div>
                <div>
                  <span class="ui-tag {{ activity | class_name | lower }}"></span> Por
                  <a href="{% url 'groups:group' activity.group.abbreviation %}">@{{ activity.group.abbreviation }}</a>,
                  {{ activity.datetime|date:'d/m/Y H:i' }}
                </div>
              {% endfor %}
            </div>
          </div>
          <div class="flex-pane">
            <div class="pane-title bg-grad"><h2><a href="{% url 'learning:questions' %}">Últimas dúvidas</a></h2></div>
            <div class="pane-content question-list small">
              {% for question in recent_questions %}
                <div class="question">
                  <div class="info">
                    <div class="counter votes"><span>{{ question.vote_balance }}</span></div>
                    <div class="counter answers"><span>{{ question.answer_count }}</span></div>
                  </div>
                  <div class="summary">
                    <h3><a href="{% url 'learning:question' question.activity_id %}">{{ question.title }}</a></h3>
                    <div class="tags">
                      {% for class in question.linked_classes.all %}
                        <span class="ui-tag"><a href="{% url 'college:class' class.id %}">{{ class.name }}</a></span>
                      {% endfor %}
                      {% for section in question.linked_sections.all %}
                        <span class="ui-tag"><a href="{% url 'learning:section' section.id %}">{{ section.title }}</a></span>
                      {% endfor %}
                    </div>
                    <div class="author">
                      Por <a href="{% url 'users:profile' question.user.nickname %}">{{ question.user }}</a>
                    </div>
                  </div>
                </div>
                {% if not forloop.last %}
                  <hr>{% endif %}
              {% endfor %}
            </div>
          </div>
        </div>
        <div class="col noshrink" style="flex-basis: 500px">
          <div class="flex-pane">
            <div class="pane-title bg-grad">
              <h2><a href="{% url 'college:available_places' %}">Salas <b>talvez</b> vazias</a></h2>
            </div>
            <div class="pane-content room-list">
              {% for room in free_rooms %}
                <a class="room-type-{{ room.type }}" href="{% url 'college:room' room.id %}">
                  {{ room }}
                </a>
              {% endfor %}
            </div>
          </div>
          <div class="flex-pane">
            <div class="pane-title bg-grad"><h2><a href="{% url 'changelog' %}">Alterações</a></h2></div>
            <div class="pane-content">
              <h3>{{ changelog.title }}</h3>
              {{ changelog.content_html | safe }}
            </div>
          </div>
          <div class="flex-pane">
            <div class="pane-title bg-grad"><h2>Os astros</h2></div>
            <div class="pane-content">
            O Supernova tem hoje <big>{{ student_count }}</big> alunos e <big>{{ teacher_count }}</big> professores.<br>
            <big>{{ allowing_teacher_count }}</big> professores <a href="{% url 'college:teachers_consent' %}">autorizaram</a> que utilizassemos os seus materiais.
            <hr>
            <div style="text-align: center">
              <span>{{ pledge_count }}</span> membros que <a href="{% url 'support' %}">peticionaram</a> a UNL para apoiar o Supernova.<br>
              <b><a href="{% url 'support' %}">Manifesta o teu apoio!</a></b>
            </div>
            </div>
          </div>
        </div>
      </div>
      <img class="main-footer lowres" src="{% static 'img/banner.svg' %}">
    </div>
    <div class="col medium nogrow">
      {% if pinned_news|length > 0 %}
        <div class="flex-pane">
          <div class="pane-title bg-grad">
            <h2>Avisos</h2>
          </div>
          <ul style="list-style: square">
            {% for entry in pinned_news %}
              <li class="entity"><a href="{{ entry.get_absolute_url }}">{{ entry.title }}</a></li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
      <div class="flex-pane">
        <div class="pane-title bg-grad">
          <h2><a href="{% url 'college:transportation' %}">Transportes</a></h2>
        </div>
        <div id="transportation-widget" class="pane-content" data-endpoint="{% url 'api:transportation_upcoming' %}"></div>
      </div>
      <div class="flex-pane">
        <div class="pane-title bg-grad">
          <h2><a href="{% url 'services:service' "cantina" %}">Cantina</a></h2>
        </div>
        <div class="pane-content meals" style="height: 100%; overflow: hidden">
          <span>{{ meal_name }} a {{ meal_date }}:</span>
          {% for item in meal_items %}
            <div>
              {% if item.0 == 0 %}
                <img src="{% static 'services/soup.svg' %}">
              {% elif item.0 == 1 %}
                <img src="{% static 'services/meat.svg' %}">
              {% elif item.0 == 2 %}
                <img src="{% static 'services/fish.svg' %}">
              {% elif item.0 == 3 %}
                <img src="{% static 'services/veg.svg' %}">
              {% else %}
                <img src="{% static 'img/icons/unknown.svg' %}">
              {% endif %}
              {{ item.1 }}
            </div>
          {% endfor %}
          {% if meal_items|length == 0 %}
            <div>Sem informação</div>
          {% endif %}
          <span style="float: right; font-size: 10px">Informação obtida de <a href="https://sas.unl.pt/alimentacao/cantina-da-faculdade-de-ciencias-e-tecnologia-fct/">SAS NOVA</a></span>
        </div>
      </div>
      <div class="flex-pane">
        <div class="pane-title bg-grad">
          <h2>Meteorologia</h2>
        </div>
        <div class="pane-content" id="weather" style="height: 100%; overflow: hidden">
          <svg id="chart" width="320" height="180"></svg>
          <span style="float: right; font-size: 10px">Dados cedidos por <a href="https://www.ipma.pt/pt/index.html">IPMA</a></span>
        </div>
      </div>
      <div class="flex-pane">
        <div class="pane-title bg-grad">
          <h2>BOINC (<a href="https://www.boincstats.com/stats/-1/team/detail/2068385380/overview">NOVA Lisboa</a>)</h2>
        </div>
        <div id="boinc" class="pane-content" data-endpoint="{% url 'api:boinc' %}"></div>
      </div>
      <div class="flex-pane">
        <div class="pane-title bg-grad">
          <h2>Fala connosco</h2>
        </div>
        <div class="pane-content" style="display: flex; justify-content: space-between; filter: grayscale(50%);">
          <a href="{{ matrix_url }}">
            <img src="{% static 'img/third-party/element.svg' %}" alt="matrix" width="64px" height="64px">
          </a>
          <a href="{{ telegram_url }}">
            <img src="{% static 'img/third-party/telegram.svg' %}" alt="telegram" width="64px" height="64px">
          </a>
          <a href="{{ mastodon_url }}">
            <img src="{% static 'img/third-party/mastodon.svg' %}" alt="mastodon" width="64px" height="64px">
          </a>
          {#          <a href="{{ gitlab_url }}">#}
          {#            <img src="{% static 'img/third-party/gitlab.svg' %}" alt="gitlab" width="64px" height="64px">#}
          {#          </a>#}
        </div>
      </div>
    </div>
  </div>
  <img class="main-footer highres" src="{% static 'img/banner.svg' %}">
  <script async src="{% static "services/weather.js" %}"></script>
  <script async>
      window.addEventListener("load", () => {
          loadTransportation();
          loadBOINC();
      });
  </script>
{% endblock %}
